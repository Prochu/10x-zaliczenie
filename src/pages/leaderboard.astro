---
import Layout from "../layouts/Layout.astro";
import LeaderboardHeader from "../components/LeaderboardHeader";
import LeaderboardContainer from "../components/LeaderboardContainer";

const title = "Leaderboard - BetBuddy";

// Check authentication
const supabase = Astro.locals.supabase;
const {
  data: { user },
  error,
} = await supabase.auth.getUser();

// Mock user data based on seed-users.mjs (lines 28-31)
const mockUser = {
  id: "00000000-0000-0000-0000-000000000001",
  nickname: "Alice",
  isAdmin: false,
  groups: [],
};

let currentUser;

if (error || !user) {
  // Use mock user instead of redirecting
  currentUser = mockUser;
} else {
  // Get current user profile
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("id, nickname, is_admin, groups:user_groups(group_id, groups(*))")
    .eq("id", user.id)
    .single();

  if (profileError || !profile) {
    // Use mock user if profile not found
    currentUser = mockUser;
  } else {
    // Transform to MeDto format
    currentUser = {
      id: profile.id,
      nickname: profile.nickname,
      isAdmin: profile.is_admin,
      groups:
        profile.groups?.map((gm) => ({
          id: gm.groups.id,
          name: gm.groups.name,
          isDefault: gm.groups.is_default,
        })) || [],
    };
  }
}
---

<Layout title={title} showNavigation={true}>
  <main class="min-h-screen bg-background pb-20 md:pb-8">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <LeaderboardHeader totalPlayers={undefined} lastUpdated={undefined} client:load />

      <LeaderboardContainer currentUser={currentUser} client:load />
    </div>
  </main>
</Layout>
